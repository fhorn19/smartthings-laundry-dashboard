<!DOCTYPE html>
<html>
<head>
  <title>Laundry Notifications</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: white;
      margin: 0;
      padding: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      background: #222;
      box-sizing: border-box;
    }
    header h1 {
      margin: 0;
      font-size: 24px;
      user-select: none;
    }
    #settingsBtn {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      user-select: none;
    }
    #dashboard, #settings {
      flex: 1;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: start;
      padding: 10px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    #dashboard.active, #settings.active {
      display: flex;
    }
    #buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      width: 100%;
      max-width: 600px;
      padding: 10px 0;
      box-sizing: border-box;
    }
    .btn {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 18px;
      border: none;
      border-radius: 12px;
      padding: 20px;
      color: white;
      transition: background 0.3s, filter 0.3s;
      aspect-ratio: 1 / 1;
      cursor: pointer;
      user-select: none;
    }
    .btn.on {
      background: green;
      filter: none;
    }
    .btn.off {
      background: #333;
      filter: brightness(0.5);
    }
    .bell-icon {
      font-size: 36px;
      margin-bottom: 8px;
      user-select: none;
    }
    .btn.on .bell-icon {
      color: yellow;
    }
    .btn.off .bell-icon {
      color: gray;
    }

    /* Settings form styling */
    form {
      max-width: 600px;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
      user-select: none;
    }
    label {
      font-weight: bold;
      margin-bottom: 4px;
    }
    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      font-size: 16px;
      box-sizing: border-box;
    }
    .device-row {
      display: flex;
      gap: 8px;
    }
    .device-row input[type="text"] {
      flex: 1;
    }
    #saveSettingsBtn {
      padding: 12px;
      font-size: 18px;
      background: #0078d7;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      user-select: none;
      margin-top: 10px;
      align-self: flex-start;
      transition: background 0.3s;
    }
    #saveSettingsBtn:hover {
      background: #005a9e;
    }
    #settingsNote {
      font-size: 14px;
      color: #ccc;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>

  <header>
    <h1>Laundry Notifications</h1>
    <button id="settingsBtn" title="Settings" aria-label="Settings">‚öôÔ∏è</button>
  </header>

  <main>
    <!-- Dashboard View -->
    <section id="dashboard" class="active" aria-label="Dashboard">
      <div id="buttons" role="list" aria-live="polite" aria-atomic="true"></div>
    </section>

    <!-- Settings View -->
    <section id="settings" aria-label="Settings">
      <form id="settingsForm">
        <div id="settingsNote">
          Enter your SmartThings Personal Access Token (PAT), Motion Sensor Device ID, and the four switch device IDs with friendly names.<br>
          Names can be any word(s), only the first word shows on dashboard buttons.
        </div>

        <label for="patInput">Personal Access Token (PAT):</label>
        <input id="patInput" type="password" autocomplete="off" required placeholder="Paste your PAT here" aria-required="true" />

        <label for="motionIdInput">Motion Sensor Device ID:</label>
        <input id="motionIdInput" type="text" autocomplete="off" required placeholder="Motion sensor device ID" aria-required="true" />

        <label>Switch Devices (Name and Device ID):</label>
        <div class="device-row">
          <input type="text" id="name0" placeholder="Name (e.g., Washer)" required aria-label="Switch 1 name" />
          <input type="text" id="id0" placeholder="Device ID" required aria-label="Switch 1 device ID" />
        </div>
        <div class="device-row">
          <input type="text" id="name1" placeholder="Name (e.g., Dryer)" required aria-label="Switch 2 name" />
          <input type="text" id="id1" placeholder="Device ID" required aria-label="Switch 2 device ID" />
        </div>
        <div class="device-row">
          <input type="text" id="name2" placeholder="Name" required aria-label="Switch 3 name" />
          <input type="text" id="id2" placeholder="Device ID" required aria-label="Switch 3 device ID" />
        </div>
        <div class="device-row">
          <input type="text" id="name3" placeholder="Name" required aria-label="Switch 4 name" />
          <input type="text" id="id3" placeholder="Device ID" required aria-label="Switch 4 device ID" />
        </div>

        <button id="saveSettingsBtn" type="submit">Save Settings</button>
      </form>
    </section>
  </main>

<script>
  const settingsBtn = document.getElementById('settingsBtn');
  const dashboardView = document.getElementById('dashboard');
  const settingsView = document.getElementById('settings');

  const patInput = document.getElementById('patInput');
  const motionIdInput = document.getElementById('motionIdInput');
  const saveSettingsBtn = document.getElementById('saveSettingsBtn');

  const nameInputs = [
    document.getElementById('name0'),
    document.getElementById('name1'),
    document.getElementById('name2'),
    document.getElementById('name3')
  ];
  const idInputs = [
    document.getElementById('id0'),
    document.getElementById('id1'),
    document.getElementById('id2'),
    document.getElementById('id3')
  ];

  // Load settings from localStorage or empty defaults
  function loadSettings() {
    const pat = localStorage.getItem('smartthings_pat') || '';
    const motionId = localStorage.getItem('motion_sensor_id') || '';
    const devices = JSON.parse(localStorage.getItem('device_ids') || '[]');
    patInput.value = pat;
    motionIdInput.value = motionId;
    for (let i = 0; i < 4; i++) {
      if (devices[i]) {
        nameInputs[i].value = devices[i].name || '';
        idInputs[i].value = devices[i].id || '';
      } else {
        nameInputs[i].value = '';
        idInputs[i].value = '';
      }
    }
  }

  // Save settings to localStorage
  function saveSettings() {
    const pat = patInput.value.trim();
    const motionId = motionIdInput.value.trim();
    if (!pat || !motionId) {
      alert('Please enter your PAT and motion sensor device ID.');
      return false;
    }
    const devices = [];
    for (let i = 0; i < 4; i++) {
      const name = nameInputs[i].value.trim();
      const id = idInputs[i].value.trim();
      if (!name || !id) {
        alert('Please enter name and device ID for all 4 switches.');
        return false;
      }
      devices.push({ name, id });
    }
    localStorage.setItem('smartthings_pat', pat);
    localStorage.setItem('motion_sensor_id', motionId);
    localStorage.setItem('device_ids', JSON.stringify(devices));
    return true;
  }

  // Switch to dashboard view
  function showDashboard() {
    settingsView.classList.remove('active');
    dashboardView.classList.add('active');
  }

  // Switch to settings view
  function showSettings() {
    dashboardView.classList.remove('active');
    settingsView.classList.add('active');
  }

  // Validate settings exist on load and decide which view to show
  function checkSettingsOrShowSettings() {
    const pat = localStorage.getItem('smartthings_pat');
    const motionId = localStorage.getItem('motion_sensor_id');
    const devices = JSON.parse(localStorage.getItem('device_ids') || '[]');
    if (!pat || !motionId || devices.length !== 4) {
      showSettings();
    } else {
      showDashboard();
    }
  }

  // Initialize settings form and views on page load
  window.addEventListener('DOMContentLoaded', () => {
    loadSettings();
    checkSettingsOrShowSettings();
  });

  // Handle settings button toggle
  settingsBtn.addEventListener('

click', () => {
if (settingsView.classList.contains('active')) {
// Save settings and go to dashboard if valid
if (saveSettings()) {
loadSettings();
startApp();
showDashboard();
}
} else {
// Show settings view
loadSettings();
showSettings();
}
});

// Also handle form submit for save button
document.getElementById('settingsForm').addEventListener('submit', e => {
e.preventDefault();
if (saveSettings()) {
loadSettings();
startApp();
showDashboard();
}
});

// --- SmartThings Integration and App Logic ---

let token = '';
let motionSensorId = '';
let switches = [];

let headers = {};
let wakeLock = null;
let lastMotionTime = 0;
let currentMotionState = null;
let pollIntervalId = null;

async function requestWakeLock() {
try {
if ('wakeLock' in navigator) {
if (!wakeLock) {
wakeLock = await navigator.wakeLock.request('screen');
wakeLock.addEventListener('release', () => {
wakeLock = null;
});
console.log('Wake Lock acquired');
}
}
} catch (err) {
console.error('Wake Lock error:', err);
}
}

function releaseWakeLock() {
if (wakeLock) {
wakeLock.release();
wakeLock = null;
console.log('Wake Lock released');
}
}

async function fetchStatus(device) {
try {
const res = await fetch(https://api.smartthings.com/v1/devices/${device.id}/status, { headers });
if (!res.ok) {
throw new Error(Status fetch failed for ${device.name});
}
const json = await res.json();
return json.components.main.switch.switch.value === 'on';
} catch (e) {
console.error(e);
return false;
}
}

async function sendToggle(device, currentState) {
const command = currentState ? "off" : "on";
try {
const res = await fetch(https://api.smartthings.com/v1/devices/${device.id}/commands, {
method: 'POST',
headers,
body: JSON.stringify({
commands: [{ component: "main", capability: "switch", command }]
})
});
if (!res.ok) {
throw new Error(Toggle failed for ${device.name});
}
} catch (e) {
console.error(e);
alert(Failed to toggle ${device.name}. Check your network and PAT.);
}
}

async function updateButtons() {
const container = document.getElementById("buttons");
container.innerHTML = "";
for (const device of switches) {
const isOn = await fetchStatus(device);
const btn = document.createElement("button");
btn.className = "btn " + (isOn ? "on" : "off");
const firstWord = device.name.split(/\s+/)[0];
btn.innerHTML = <div class="bell-icon" aria-hidden="true">üîî</div>${firstWord}<br><small>(${isOn ? "ON" : "OFF"})</small>;
btn.onclick = async () => {
btn.disabled = true;
await sendToggle(device, isOn);
await updateButtons();
btn.disabled = false;
};
container.appendChild(btn);
}
}

async function pollMotionSensor() {
try {
const res = await fetch(https://api.smartthings.com/v1/devices/${motionSensorId}/status, { headers });
if (!res.ok) {
throw new Error('Motion sensor fetch failed');
}
const json = await res.json();
const motionVal = json.components.main.motion.motion.value;
if (motionVal !== currentMotionState) {
currentMotionState = motionVal;
if (motionVal === 'active') {
// Motion detected - wake screen and refresh buttons
lastMotionTime = Date.now();
await requestWakeLock();
await updateButtons();
}
}
// If no motion for 30s, release wake lock
if (Date.now() - lastMotionTime > 30000) {
releaseWakeLock();
}
} catch (e) {
console.error('Motion poll error:', e);
}
}

function startApp() {
token = localStorage.getItem('smartthings_pat');
motionSensorId = localStorage.getItem('motion_sensor_id');
switches = JSON.parse(localStorage.getItem('device_ids')) || [];
headers = {
  "Authorization": "Bearer " + token,
  "Content-Type": "application/json"
};

if (pollIntervalId) clearInterval(pollIntervalId);
pollIntervalId = setInterval(pollMotionSensor, 3000);
updateButtons();
}

// Start app if settings valid on load
window.addEventListener('DOMContentLoaded', () => {
const pat = localStorage.getItem('smartthings_pat');
const motionId = localStorage.getItem('motion_sensor_id');
const devices = JSON.parse(localStorage.getItem('device_ids') || '[]');
if (pat && motionId && devices.length === 4) {
startApp();
}
});
</script>

</body> </html> ```
